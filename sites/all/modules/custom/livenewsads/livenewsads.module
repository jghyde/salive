<?php

/**
 * Implements hook_node_view().
 */
function livenewsads_node_view($node, $view_mode, $langcode) {
  if ($view_mode == 'full' && $node->type == 'article') {
    drupal_add_css(drupal_get_path('module', 'livenewsads') . '/css/livenewsads.css');
    if (isset($node->field_category[LANGUAGE_NONE]) && !empty($node->field_category[LANGUAGE_NONE])) {
      foreach ($node->field_category[LANGUAGE_NONE] as $k => $v) {
        if (empty($t)) {
          if ($v['tid'] == '31') {
            $t = 'crime';
          }
          if ($v['tid'] == '44') {
            $t = 'crashes';
          }
          if ($v['tid'] == '51') {
            $t = 'health';
          }
          else {
            $t = 'all';
          }
        }
      }
    }
    $two = $three = $four = FALSE;
    if (strlen($node->content['body'][0]['#markup']) > 550) {
      $two = FALSE;
      $dom = new simple_html_dom();
      $dom->load($node->content['body'][0]['#markup']);
      // determine the number of ads
      $paras = [];
      foreach ($dom->find("p") as $element) {
        $paras[] = $element->outertext;
      }
      $ad_count = ceil((int) count($paras) / 5);
      $defined_slots = [];
      $adspot = [];
      for ($x = 1; $x <= $ad_count; $x++) {
        $block = block_load('dfp', 'newsbody_' . $x);
        //drupal_render(_block_get_renderable_array(_block_render_blocks(array($block))));
        $adspot[$x] = drupal_render(_block_get_renderable_array(_block_render_blocks(array($block))));
      }

      $string = substr($node->content['body'][0]['#markup'], 0, strpos($node->content['body'][0]['#markup'], "</p>") + 4);
      // add the banner ad code
      $banner_added = $string . render($adspot[1]);
      // add the first banner the old fashioned way
      $node->content['body'][0]['#markup'] = str_replace($string, $banner_added, $node->content['body'][0]['#markup']);
      $show_ads = 1;
      if (isset($node->field_insert_ads[LANGUAGE_NONE][0]['value'])) {
        if ($node->field_insert_ads[LANGUAGE_NONE][0]['value'] == 1) {
          $show_ads = 0;
        }
      }
      if ($show_ads == 1) {
        // Above, we placed the first ad, so start with ad #2. The array() starts at 1.
        $i = 2;
        for ($x = 5; $x <= count($paras); $x++) {
          if ($x % 5 == 0) {
            $string = $paras[$x];
            $banner_added = render($adspot[$i]) . $string;
            $happy = str_replace($string, $banner_added, $node->content['body'][0]['#markup']);
            $node->content['body'][0]['#markup'] = str_replace($string, $banner_added, $node->content['body'][0]['#markup']);
            $i++;
          }
        }
        // For Google Surveys
        // Google Surveys
        $js = <<<EOT
(function() {
  var ARTICLE_URL = window.location.href;
  var CONTENT_ID = 'everything';
  document.write(
    '<scr'+'ipt '+
    'src="//survey.g.doubleclick.net/survey?site=_svfs4ntpfivgotmieqafjocpeu'+
    '&amp;url='+encodeURIComponent(ARTICLE_URL)+
    (CONTENT_ID ? '&amp;cid='+encodeURIComponent(CONTENT_ID) : '')+
    '&amp;random='+(new Date).getTime()+
    '" type="text/javascript">'+'\x3C/scr'+'ipt>');
})();
EOT;
        drupal_add_js($js, [
          'type' => 'inline',
          'scope' => 'header',
          'weight' => -1,
        ]);
        $js = <<<EOT
try { _402_Show(); } catch(e) {}
EOT;
        $prefix = '<div class="p402_premium">';
        $suffix = "</div><script type=\"text/javascript\">\n" . $js . "\n" . "</script>";
        $node->content['body'][0]['#markup'] = $prefix . $node->content['body'][0]['#markup'] . $suffix;
        $thumbs = views_embed_view('news_thumbs', 'block');
        $node->content['body'][0]['#markup'] .= '<div id="block-views-news-thumbs-block" class="clearfix"><h2>Recommended for You</h2>' . $thumbs . '</div>';
      }
    }
  }
  if ($node->type == 'article') {

    $copyright = '<div class="copyright"> &copy; ' . date('Y') . ' Copyright Hyde Interactive, Inc. All rights reserved. This material may not be published, broadcast, rewritten, or redistributed.</div>';
    switch ($t) {
      case 'crime':
        $ad = block_load('dfp', 'SALive_BLW_Crime');
        $node->content['body'][0]['#markup'] .= $copyright . drupal_render(_block_get_renderable_array(_block_render_blocks(array($ad))));
        break;
      case 'crashes':
        $ad = block_load('dfp', 'SALive_BLW_Crash');
        $node->content['body'][0]['#markup'] .= $copyright . drupal_render(_block_get_renderable_array(_block_render_blocks(array($ad))));
        break;
      case 'health':
        $ad = block_load('dfp', 'SALive_BLW_Health');
        $node->content['body'][0]['#markup'] .= $copyright . drupal_render(_block_get_renderable_array(_block_render_blocks(array($ad))));
        break;
      case 'all':
        if ($node->nid != '6') {
          // @TODO add more categories
          $ad = block_load('dfp', 'SALive_BLW_Editors_Pick');
          $node->content['body'][0]['#markup'] .= $copyright . drupal_render(_block_get_renderable_array(_block_render_blocks(array($ad))));
        }
        break;
      default:
        if ($node->nid != '6') {
          // @TODO add more categories
          $ad = block_load('dfp', 'SALive_BLW_Editors_Pick');
          $node->content['body'][0]['#markup'] .= $copyright . drupal_render(_block_get_renderable_array(_block_render_blocks(array($ad))));
        }
        break;
    }
  }
  if ($node->type == 'venue') {
    $ad = block_load('dfp', 'SALive_BLW_Venue');
    $node->content['field_map'][0]['#markup'] .= drupal_render(_block_get_renderable_array(_block_render_blocks(array($ad))));
  }

}
