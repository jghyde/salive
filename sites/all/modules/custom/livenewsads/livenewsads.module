<?php

/**
 * Implements hook_node_view().
 */
function livenewsads_node_view($node, $view_mode, $langcode) {
	$t = '';
  if ($view_mode == 'full' && $node->type == 'article') {
	  drupal_add_css(drupal_get_path('module', 'livenewsads') .  '/css/livenewsads.css');
    if (isset($node->field_category[LANGUAGE_NONE]) && !empty($node->field_category[LANGUAGE_NONE])) {
      foreach($node->field_category[LANGUAGE_NONE] as $k => $v) {
        if (empty($t)) {
          if ($v['tid'] == '31') {
            $t = 'crime';
          }
          if ($v['tid'] == '44' || $v['tid'] == '16') {
            $t = 'crashes';
          }
        }
      }
    }
    $two = $three = $four = $five = $six = $seven = $eight = $nine = $ten = $eleven = $twelve = $therteen = $fourteen = $fifteen = $sexteen = $seventeen = FALSE;
    if (strlen($node->content['body'][0]['#markup']) > 550) {
      $two = FALSE;
      $dom = new simple_html_dom();
      $dom->load($node->content['body'][0]['#markup']);
      // Count paragraphs
      $paras = $dom->find("p");
      if (count($paras) > 7) {
        $two = TRUE;
      }
      if (count($paras) > 12) {
        $three = TRUE;
      }
      if (count($paras) > 17) {
        $four = TRUE;
      }
      if (count($paras) > 22) {
        $five = TRUE;
      }
      if (count($paras) > 27) {
        $six = TRUE;
      }
      if (count($paras) > 32) {
        $seven = TRUE;
      }
      if (count($paras) > 37) {
        $eight = TRUE;
      }
      if (count($paras) > 42) {
        $nine = TRUE;
      }
      if (count($paras) > 47) {
        $ten = TRUE;
      }
      if (count($paras) > 52) {
        $eleven = TRUE;
      }
      if (count($paras) > 57) {
        $twelve = TRUE;
      }
      if (count($paras) > 62) {
        $therteen = TRUE;
      }
      if (count($paras) > 67) {
        $fourteen = TRUE;
      }
      if (count($paras) > 72) {
        $fifteen = TRUE;
      }
      if (count($paras) > 77) {
        $sexteen = TRUE;
      }
      if (count($paras) > 82) {
        $seventeen = TRUE;
      }
      $string = substr($node->content['body'][0]['#markup'], 0, strpos($node->content['body'][0]['#markup'], "</p>")+4);
      // add the banner ad code
      $banner_added = $string . '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>';
      // add the first banner the old fashioned way
      $node->content['body'][0]['#markup'] = str_replace($string, $banner_added, $node->content['body'][0]['#markup']);
      if ($two) {
        $string2 = $paras[5];
        $banner_added2 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string2;
        $node->content['body'][0]['#markup'] = str_replace($string2, $banner_added2, $node->content['body'][0]['#markup']);
      }
      if ($three) {
        $string3 = $paras[10];
        $banner_added3 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string3;
        $node->content['body'][0]['#markup'] = str_replace($string3, $banner_added3, $node->content['body'][0]['#markup']);
      }
      if ($four) {
        $string4 = $paras[15];
        $banner_added4 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string4;
        $node->content['body'][0]['#markup'] = str_replace($string4, $banner_added4, $node->content['body'][0]['#markup']);
      }
      if ($five) {
        $string5 = $paras[20];
        $banner_added5 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string5;
        $node->content['body'][0]['#markup'] = str_replace($string5, $banner_added5, $node->content['body'][0]['#markup']);
      }
      if ($six) {
        $string6 = $paras[25];
        $banner_added6 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string6;
        $node->content['body'][0]['#markup'] = str_replace($string6, $banner_added6, $node->content['body'][0]['#markup']);
      }
      if ($seven) {
        $string7 = $paras[30];
        $banner_added7 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string7;
        $node->content['body'][0]['#markup'] = str_replace($string7, $banner_added7, $node->content['body'][0]['#markup']);
      }
      if ($eight) {
        $string8 = $paras[35];
        $banner_added8 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string8;
        $node->content['body'][0]['#markup'] = str_replace($string8, $banner_added8, $node->content['body'][0]['#markup']);
      }
      if ($nine) {
        $string9 = $paras[40];
        $banner_added9 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string9;
        $node->content['body'][0]['#markup'] = str_replace($string9, $banner_added9, $node->content['body'][0]['#markup']);
      }
      if ($ten) {
        $string10 = $paras[45];
        $banner_added10 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string10;
        $node->content['body'][0]['#markup'] = str_replace($string10, $banner_added10, $node->content['body'][0]['#markup']);
      }
      if ($eleven) {
        $string11 = $paras[50];
        $banner_added11 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string11;
        $node->content['body'][0]['#markup'] = str_replace($string11, $banner_added11, $node->content['body'][0]['#markup']);
      }
      if ($twelve) {
        $string12 = $paras[55];
        $banner_added12 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string12;
        $node->content['body'][0]['#markup'] = str_replace($string12, $banner_added12, $node->content['body'][0]['#markup']);
      }
      if ($therteen) {
        $string13 = $paras[60];
        $banner_added13 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string13;
        $node->content['body'][0]['#markup'] = str_replace($string13, $banner_added13, $node->content['body'][0]['#markup']);
      }
      if ($fourteen) {
        $string14 = $paras[65];
        $banner_added14 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string14;
        $node->content['body'][0]['#markup'] = str_replace($string14, $banner_added14, $node->content['body'][0]['#markup']);
      }
      if ($fifteen) {
        $string15 = $paras[70];
        $banner_added15 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string15;
        $node->content['body'][0]['#markup'] = str_replace($string15, $banner_added15, $node->content['body'][0]['#markup']);
      }
      if ($sixteen) {
        $string16 = $paras[75];
        $banner_added16 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string16;
        $node->content['body'][0]['#markup'] = str_replace($string16, $banner_added16, $node->content['body'][0]['#markup']);
      }
      if (isset($seventeen) && $seventeen == TRUE) {
        $string17 = $paras[80];
        $banner_added17 =  '<div class="newsbodyplacement ads"><a><img src="/sites/default/files/350x292.png"></a></div>' . $string17;
        $node->content['body'][0]['#markup'] = str_replace($string17, $banner_added17, $node->content['body'][0]['#markup']);
      }
    }
  }
  // Add the ad placement at the end of the article
  // For Crime:

  if ($node->type == 'article') {
    switch ($t) {
      case 'crime':
        $node->content['body'][0]['#markup'] .= '<div class="ads"><a><img src="/sites/default/files/930x180.png"></a>/div>';
        break;
      case 'crashes':
        $node->content['body'][0]['#markup'] .= '<div class="ads"><a><img src="/sites/default/files/930x180.png"></a></div>';
        break;
      default:
        if ($node->nid != '6') {
          $node->content['body'][0]['#markup'] .= '<div class="ads"><a><img src="/sites/default/files/930x180.png"></a></div>';
        }
        break;
    }
    $thumbs = views_embed_view('news_thumbs', 'block');
    $node->content['body'][0]['#markup'] .= '<div id="block-views-news-thumbs-block" class="clearfix"><h2>Recommended for You</h2>' . $thumbs . '</div>';  
  }
	if ($node->type == 'venue') {
	  $node->content['field_map'][0]['#markup'] .= '<div class="ads"><a><img src="/sites/default/files/930x180.png"></a></div>';
	}
  return $node;
}

